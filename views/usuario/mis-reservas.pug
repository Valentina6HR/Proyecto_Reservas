extends ../layout/index
include ../mixins/errores

block contenido
    +mostrarErrores(errores)
    
    section.py-8.min-h-screen
        .container.mx-auto.px-4.max-w-6xl
            //- Header de la p√°gina
            .mb-8(data-aos="fade-down")
                .flex.flex-col.md_flex-row.justify-between.items-start.md_items-center.gap-4
                    div
                        h1.text-4xl.font-serif.text-vino.font-bold.mb-2 Mis Reservas
                        p.text-gray-600 Consulta el estado de tus reservas y gesti√≥nalas

                    //- Bot√≥n para hacer nueva reserva
                    a.bg-dorado.text-vino.px-6.py-3.rounded-lg.font-bold.hover_bg-opacity-90.transition-all.flex.items-center.gap-2.shadow-lg(href="/reservas")
                        svg.w-5.h-5(xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor")
                            path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6")
                        | Nueva Reserva

            //- Notificaciones de cambios
            if tieneNotificaciones && notificaciones.length > 0
                - const notifIds = notificaciones.map(n => n.id).join(',')
                #notificaciones-container.mb-6(data-aos="fade-down" data-notif-ids=notifIds)
                    .notificacion-alert.bg-blue-50.border-l-4.border-blue-500.rounded-r-lg.p-4.shadow-md.relative.transition-all
                        //- Bot√≥n cerrar
                        button#btn-cerrar-notificaciones.absolute.top-2.right-2.text-blue-400.hover_text-blue-600.transition-colors.p-1(type="button" title="Cerrar notificaciones")
                            svg.w-5.h-5(xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor")
                                path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12")
                        
                        .flex.items-start.gap-3.pr-6
                            .flex-shrink-0
                                svg.w-6.h-6.text-blue-500(xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor")
                                    path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9")
                            div.flex-1
                                .flex.items-center.justify-between.mb-2
                                    h3.font-bold.text-blue-800 Notificaciones Recientes
                                    //- Barra de progreso para auto-cierre
                                    .progress-bar.h-1.w-20.bg-blue-200.rounded-full.overflow-hidden
                                        .progress-fill.h-full.bg-blue-500.rounded-full
                                .space-y-2
                                    each notif in notificaciones
                                        .flex.items-center.justify-between.bg-white.rounded.p-2.text-sm
                                            span.text-blue-700 #{notif.mensaje}
                                            span.text-xs.text-gray-500.px-2.py-1.rounded.bg-gray-100.capitalize #{notif.estado}

            //- Reservas Activas
            .mb-8(data-aos="fade-up")
                h2.text-2xl.font-serif.text-vino.font-bold.mb-4.flex.items-center.gap-2
                    svg.w-6.h-6.text-green-600(xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor")
                        path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z")
                    | Reservas Activas
                    if reservasActivas.length > 0
                        span.bg-green-100.text-green-800.text-sm.px-3.py-1.rounded-full.font-medium #{reservasActivas.length}

                if reservasActivas.length > 0
                    .grid.gap-4(class="grid-cols-1 md:grid-cols-2")
                        each reserva in reservasActivas
                            .reserva-card.bg-white.rounded-xl.shadow-lg.overflow-hidden.border-2.transition-all.hover_shadow-xl(
                                class=reserva.esHoy ? "border-dorado" : "border-transparent"
                                data-reserva-id=reserva.id_reserva
                            )
                                //- Header de la tarjeta
                                .bg-gradient-to-r.from-vino.to-red-800.text-white.px-5.py-4
                                    .flex.justify-between.items-start
                                        div
                                            .text-xs.uppercase.tracking-wider.opacity-80 Reserva
                                            .text-2xl.font-bold ##{reserva.id_reserva}
                                        .text-right
                                            if reserva.esHoy
                                                span.bg-dorado.text-vino.px-3.py-1.rounded-full.text-xs.font-bold.animate-pulse ¬°Hoy!
                                            else
                                                span.bg-white.text-vino.bg-opacity-20.px-3.py-1.rounded-full.text-xs.font-medium Pr√≥ximamente

                                //- Contenido
                                .p-5
                                    //- Estado actual
                                    .mb-4.flex.items-center.gap-2
                                        span.text-sm.font-medium.text-gray-600 Estado:
                                        span.estado-badge.px-3.py-1.rounded-full.text-sm.font-bold(
                                            class=reserva.estado === "confirmada" ? "bg-green-100 text-green-800" : reserva.estado === "pendiente" ? "bg-yellow-100 text-yellow-800" : reserva.estado === "en_curso" ? "bg-blue-100 text-blue-800" : "bg-gray-100 text-gray-800"
                                        )
                                            if reserva.estado === "confirmada"
                                                | ‚úì Confirmada
                                            else if reserva.estado === "pendiente"
                                                | ‚è≥ Pendiente
                                            else if reserva.estado === "en_curso"
                                                | üçΩÔ∏è En Curso
                                            else
                                                | #{reserva.estado}

                                    //- Informaci√≥n de fecha y hora
                                    .grid.gap-3.mb-4(class="grid-cols-2")
                                        .flex.items-center.gap-2.text-gray-700
                                            svg.w-5.h-5.text-vino(xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor")
                                                path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z")
                                            span.font-medium #{reserva.fecha_reserva}
                                        
                                        .flex.items-center.gap-2.text-gray-700
                                            svg.w-5.h-5.text-vino(xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor")
                                                path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z")
                                            span.font-medium #{reserva.hora_inicio.substring(0, 5)}
                                        
                                        .flex.items-center.gap-2.text-gray-700
                                            svg.w-5.h-5.text-vino(xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor")
                                                path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z")
                                            span.font-medium #{reserva.numero_personas} personas

                                    //- Mesa asignada
                                    if reserva.mesa
                                        .bg-gray-50.rounded-lg.p-3.mb-4
                                            .flex.items-center.gap-3
                                                .w-12.h-12.rounded-lg.bg-gradient-to-br.from-vino.to-red-800.flex.items-center.justify-center.shadow
                                                    span.text-white.font-bold #{reserva.mesa.id}
                                                div.flex-1
                                                    .text-sm.text-gray-500 Mesa Asignada
                                                    .font-bold.text-vino #{reserva.mesa.nombre}
                                                    .text-xs.text-gray-500
                                                        if reserva.mesa.zona
                                                            span.capitalize #{reserva.mesa.zona}
                                                            span.mx-1 ‚Ä¢
                                                        span Capacidad: #{reserva.mesa.capacidad}
                                    else
                                        .bg-yellow-50.rounded-lg.p-3.mb-4.border.border-yellow-200
                                            .flex.items-center.gap-2.text-yellow-700
                                                svg.w-5.h-5(xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor")
                                                    path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z")
                                                span.text-sm Mesa pendiente de asignaci√≥n

                                    //- Bot√≥n de cancelar
                                    if reserva.puedeCancelar
                                        form(method="POST" action=`/mis-reservas/${reserva.id_reserva}/cancelar` onsubmit="return confirm('¬øEst√°s seguro de que deseas cancelar esta reserva? Esta acci√≥n no se puede deshacer.')")
                                            input(type="hidden" name="_csrf" value=csrfToken)
                                            button.w-full.bg-red-50.text-red-600.border.border-red-200.py-2.px-4.rounded-lg.font-medium.hover_bg-red-100.transition-colors.flex.items-center.justify-center.gap-2.cursor-pointer.hover_shadow-md(type="submit")
                                                svg.w-4.h-4(xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor")
                                                    path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12")
                                                | Cancelar Reserva
                                    else
                                        .text-center.text-xs.text-gray-400.italic
                                            | No se puede cancelar (menos de 1 hora de antelaci√≥n)

                else
                    .bg-gray-50.rounded-xl.p-8.text-center.border-2.border-dashed.border-gray-300
                        svg.w-16.h-16.mx-auto.mb-4.text-gray-400(xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor")
                            path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z")
                        h3.text-lg.font-bold.text-gray-600.mb-2 No tienes reservas activas
                        p.text-gray-500.mb-4 ¬°Haz tu primera reserva y disfruta de nuestra cocina italiana!
                        a.inline-block.bg-vino.text-white.px-6.py-3.rounded-lg.font-bold.hover_bg-opacity-90.transition-colors(href="/reservas") Hacer Reserva

            //- Reservas Pasadas
            if reservasPasadas.length > 0
                .mb-8(data-aos="fade-up")
                    details.group
                        summary.cursor-pointer.flex.items-center.gap-2.text-xl.font-serif.text-gray-600.font-bold.mb-4.hover_text-vino.transition-colors
                            svg.w-5.h-5.transform.transition-transform.group-open_rotate-90(xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor")
                                path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7")
                            | Historial de Reservas
                            span.bg-gray-200.text-gray-600.text-sm.px-3.py-1.rounded-full.font-medium.ml-2 #{reservasPasadas.length}
                        
                        .grid.gap-3.mt-4(class="grid-cols-1 md:grid-cols-2 lg:grid-cols-3")
                            each reserva in reservasPasadas
                                .bg-white.rounded-lg.shadow.p-4.border.border-gray-100.opacity-75
                                    .flex.justify-between.items-start.mb-2
                                        .text-lg.font-bold.text-gray-600 ##{reserva.id_reserva}
                                        span.px-2.py-1.rounded.text-xs.font-medium(
                                            class=reserva.estado === "completada" ? "bg-green-100 text-green-700" : "bg-gray-100 text-gray-600"
                                        )
                                            if reserva.estado === "completada"
                                                | ‚úì Completada
                                            else if reserva.estado === "no_show"
                                                | ‚úó No asisti√≥
                                            else
                                                | #{reserva.estado}
                                    .text-sm.text-gray-500
                                        .flex.items-center.gap-2.mb-1
                                            svg.w-4.h-4(xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor")
                                                path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z")
                                            | #{reserva.fecha_reserva} a las #{reserva.hora_inicio.substring(0, 5)}
                                        if reserva.mesa
                                            .flex.items-center.gap-2
                                                svg.w-4.h-4(xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor")
                                                    path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z")
                                                | #{reserva.mesa.nombre}

            //- Reservas Canceladas
            if reservasCanceladas.length > 0
                .mb-8(data-aos="fade-up")
                    details.group
                        summary.cursor-pointer.flex.items-center.gap-2.text-xl.font-serif.text-gray-400.font-bold.mb-4.hover_text-gray-600.transition-colors
                            svg.w-5.h-5.transform.transition-transform.group-open_rotate-90(xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor")
                                path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7")
                            | Reservas Canceladas
                            span.bg-red-100.text-red-600.text-sm.px-3.py-1.rounded-full.font-medium.ml-2 #{reservasCanceladas.length}
                        
                        .grid.gap-3.mt-4(class="grid-cols-1 md:grid-cols-2 lg:grid-cols-3")
                            each reserva in reservasCanceladas
                                .bg-red-50.rounded-lg.p-4.border.border-red-100.opacity-60
                                    .flex.justify-between.items-start.mb-2
                                        .text-lg.font-bold.text-red-400.line-through ##{reserva.id_reserva}
                                        span.px-2.py-1.rounded.text-xs.font-medium.bg-red-100.text-red-600 ‚úó Cancelada
                                    .text-sm.text-red-400
                                        | #{reserva.fecha_reserva} a las #{reserva.hora_inicio.substring(0, 5)}

    //- Script para actualizaci√≥n en tiempo real
    script.
        // ============ NOTIFICACIONES CON AUTO-CERRADO ============
        const notificacionesContainer = document.getElementById('notificaciones-container');
        const btnCerrarNotificaciones = document.getElementById('btn-cerrar-notificaciones');
        
        if (notificacionesContainer) {
            const notifIds = notificacionesContainer.dataset.notifIds || '';
            const storageKey = 'notificaciones_vistas';
            
            // Verificar si estas notificaciones ya fueron vistas
            const notificacionesVistas = localStorage.getItem(storageKey) || '';
            const notifIdsArray = notifIds.split(',').filter(id => id);
            const vistasArray = notificacionesVistas.split(',').filter(id => id);
            
            // Comprobar si TODAS las notificaciones actuales ya fueron vistas
            const todasVistas = notifIdsArray.length > 0 && 
                                notifIdsArray.every(id => vistasArray.includes(id));
            
            if (todasVistas) {
                // Ya fueron vistas, ocultar inmediatamente
                notificacionesContainer.remove();
            } else {
                // Funci√≥n para cerrar las notificaciones con animaci√≥n y guardar en localStorage
                function cerrarNotificaciones() {
                    // Guardar que estas notificaciones ya fueron vistas
                    const nuevasVistas = [...new Set([...vistasArray, ...notifIdsArray])];
                    localStorage.setItem(storageKey, nuevasVistas.join(','));
                    
                    const notificacionAlert = notificacionesContainer.querySelector('.notificacion-alert');
                    if (notificacionAlert) {
                        notificacionAlert.style.opacity = '0';
                        notificacionAlert.style.transform = 'translateY(-10px)';
                        setTimeout(() => {
                            notificacionesContainer.remove();
                        }, 300);
                    }
                }
                
                // Cerrar al hacer clic en el bot√≥n X
                if (btnCerrarNotificaciones) {
                    btnCerrarNotificaciones.addEventListener('click', cerrarNotificaciones);
                }
                
                // Auto-cerrar despu√©s de 5 segundos
                setTimeout(cerrarNotificaciones, 5000);
            }
            
            // Limpiar notificaciones viejas del localStorage (m√°s de 24 horas)
            // Se hace cada vez que se carga la p√°gina
            try {
                const ultimaLimpieza = localStorage.getItem('notif_ultima_limpieza');
                const ahora = Date.now();
                const unDia = 24 * 60 * 60 * 1000;
                
                if (!ultimaLimpieza || (ahora - parseInt(ultimaLimpieza)) > unDia) {
                    // Limpiar notificaciones viejas
                    localStorage.setItem(storageKey, notifIds);
                    localStorage.setItem('notif_ultima_limpieza', ahora.toString());
                }
            } catch (e) {
                console.log('Error limpiando localStorage:', e);
            }
        }
        
        // ============ ACTUALIZACI√ìN EN TIEMPO REAL ============
        const reservaCards = document.querySelectorAll('.reserva-card');
        
        if (reservaCards.length > 0) {
            setInterval(async () => {
                reservaCards.forEach(async (card) => {
                    const reservaId = card.dataset.reservaId;
                    try {
                        const response = await fetch(`/mis-reservas/api/${reservaId}/estado`);
                        if (response.ok) {
                            const data = await response.json();
                            const estadoBadge = card.querySelector('.estado-badge');
                            if (estadoBadge) {
                                // Actualizar el estado visualmente
                                const estadoActual = estadoBadge.textContent.trim().toLowerCase();
                                if (!estadoActual.includes(data.estado)) {
                                    // Estado cambi√≥, mostrar notificaci√≥n
                                    card.classList.add('ring-2', 'ring-blue-500');
                                    setTimeout(() => {
                                        card.classList.remove('ring-2', 'ring-blue-500');
                                    }, 3000);
                                }
                            }
                        }
                    } catch (error) {
                        console.log('Error actualizando estado:', error);
                    }
                });
            }, 30000); // 30 segundos
        }

    style.
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .7; }
        }
        
        details[open] summary svg {
            transform: rotate(90deg);
        }
        
        .reserva-card {
            transition: all 0.3s ease;
        }
        
        .reserva-card:hover {
            transform: translateY(-2px);
        }
        
        /* Estilos para notificaciones */
        .notificacion-alert {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        /* Animaci√≥n de la barra de progreso */
        .progress-fill {
            animation: progressShrink 5s linear forwards;
        }
        
        @keyframes progressShrink {
            from { width: 100%; }
            to { width: 0%; }
        }
        
        #btn-cerrar-notificaciones:hover {
            transform: scale(1.1);
        }
        
        #btn-cerrar-notificaciones {
            transition: all 0.2s ease;
        }
